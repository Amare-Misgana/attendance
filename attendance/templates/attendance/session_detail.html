{% extends 'fragments/dashboard_frag.html' %}
{% load static %}

{% block title %}
  Session: {{ session.title }}
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'attendance/css/session_detail.css' %}" />
{% endblock %}

{% block content %}
  <div class="session-header">
    <div>
      <h1>{{ session.title }}</h1>
      <p>Created: {{ session.created_at|date:'M d, Y H:i' }} | Targets: {{ attendance_list|length }}</p>
    </div>

    {% if not session.is_ended %}
      <form id="finalize-form" action="{% url 'close_attendance_session' session.id %}" method="POST">
        {% csrf_token %}
        <button type="button" id="open-modal-btn" class="btn-danger"><i class="fas fa-lock"></i> End & Finalize</button>
      </form>
    {% else %}
      <span class="badge-closed">Session Closed</span>
    {% endif %}
  </div>

  <div class="search-container">
    <input type="text" id="search-student" placeholder="Search students..." />
  </div>

  <table class="attendance-table">
    <thead>
      <tr>
        <th>Student</th>
        <th>Grade / Section</th>
        <th>Status</th>
        {% if not session.is_ended %}
          <th>Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for item in attendance_list %}
        <tr>
          <td>{{ item.user.username }}</td>
          <td>
            {% if item.profile %}
              {{ item.profile.grade }} - {{ item.profile.section }}
            {% endif %}
          </td>
          <td>
            <span class="status-label status-{{ item.status }}">{{ item.status|upper }}</span>
          </td>
          {% if not session.is_ended %}
            <td>
              <form method="POST" class="action-form">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ item.user.id }}" />
                <button type="submit" name="status" value="present" class="btn-action btn-p {% if item.status == 'present' %}active{% endif %}">Present</button>
                <button type="submit" name="status" value="late" class="btn-action btn-l {% if item.status == 'late' %}active{% endif %}">Late</button>
                <button type="submit" name="status" value="absent" class="btn-action btn-a {% if item.status == 'absent' %}active{% endif %}">Absent</button>
              </form>
            </td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if not session.is_ended %}
    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-exclamation-triangle"></i> Confirm Finalization</h2>
          <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
          <p>
            You are about to <strong>END and FINALIZE</strong> the session: <strong>{{ session.title }}</strong>.
          </p>
          <p class="warning-text">
            Unmarked students will be set to <strong>ABSENT</strong>.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" id="cancel-finalize-btn" class="btn-secondary">Cancel</button>
          <button type="submit" form="finalize-form" class="btn-danger-confirm">Yes, Finalize</button>
        </div>
      </div>
    </div>
  {% endif %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const modal = document.getElementById('confirmation-modal')
      const openModalBtn = document.getElementById('open-modal-btn')
      const closeModalBtn = document.querySelector('.close-btn')
      const cancelBtn = document.getElementById('cancel-finalize-btn')
      const searchInput = document.getElementById('search-student')
      const rows = document.querySelectorAll('.attendance-table tbody tr')
    
      if (openModalBtn) openModalBtn.addEventListener('click', () => (modal.style.display = 'flex'))
      function closeModal() {
        if (modal) modal.style.display = 'none'
      }
      if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal)
      if (cancelBtn) cancelBtn.addEventListener('click', closeModal)
      window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal()
      })
    
      // Search filter
      searchInput.addEventListener('input', function () {
        const q = this.value.toLowerCase()
        rows.forEach((row) => {
          const name = row.cells[0].textContent.toLowerCase()
          const gradeSection = row.cells[1].textContent.toLowerCase()
          row.style.display = name.includes(q) || gradeSection.includes(q) ? '' : 'none'
        })
      })
    })
  </script>
{% endblock %}
